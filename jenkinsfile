pipeline {
    agent any

    options {
        timestamps()
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '15'))
        parallelsAlwaysFailFast()
    }

    parameters {
        booleanParam(name: 'PUSH_TO_DOCKER', defaultValue: false, description: 'Push images to Docker Hub when enabled')
        string(name: 'DOCKER_HUB_CREDENTIALS_ID', defaultValue: 'docker-hub-credentials', description: 'Jenkins credentials ID for Docker Hub (username+password)')
    }

    triggers {
        pollSCM('H/1 * * * *')  
    }

    environment {
        DOCKER_HUB_REPO        = 'pathum2002/personal-library'
        BACKEND_DIR           = 'Backend'
        FRONTEND_DIR          = 'frontend/frontend'
        IMAGE_TAG_BUILD       = "${env.BUILD_NUMBER}"
        IMAGE_TAG_COMMIT      = "${env.GIT_COMMIT?.take(12) ?: env.BUILD_NUMBER}"
    }

    stages {
        stage('Checkout & Setup') {
            steps {
                checkout scm
                sh """
                    echo "=== Setting up workspace ==="
                    chmod +x ${env.BACKEND_DIR}/mvnw
                    echo "‚úì Checkout completed"
                """
            }
        }

        stage('Verify Environment') {
            steps {
                sh """
                    echo "=== Environment Verification ==="
                    echo "Workspace: ${env.WORKSPACE}"
                    echo "Build Number: ${env.BUILD_NUMBER}"
                    echo "Git Commit: ${env.GIT_COMMIT}"
                    echo "Backend Dir: ${env.BACKEND_DIR}"
                    echo "Frontend Dir: ${env.FRONTEND_DIR}"
                    
                    echo "=== Directory Structure ==="
                    echo "Backend contents:"
                    ls -la ${env.BACKEND_DIR}/ || echo "Backend directory not found"
                    echo "Frontend contents:"
                    ls -la ${env.FRONTEND_DIR}/ || echo "Frontend directory not found"
                    
                    echo "=== Tools Verification ==="
                    java -version || echo "Java not available"
                    docker --version || echo "Docker not available"
                    echo "‚úì Environment verification completed"
                """
            }
        }

        stage('Build & Test Backend') {
            steps {
                dir("${env.BACKEND_DIR}") {
                    sh '''
                        echo "=== Building Backend Application ==="
                        chmod +x ./mvnw
                        ./mvnw -B -DskipTests=true clean compile
                        echo "‚úì Backend build completed"
                    '''
                }
            }
        }

        stage('Build Docker Images') {
            parallel {
                stage('Backend Image') {
                    steps {
                        dir("${env.BACKEND_DIR}") {
                            script {
                                echo "=== Building Backend Docker Image ==="
                                def base = "${env.DOCKER_HUB_REPO}-backend"
                                
                                // Check if Dockerfile exists
                                if (!fileExists('Dockerfile')) {
                                    error "Dockerfile not found in backend directory"
                                }
                                
                                sh """
                                    echo "Building Docker image: ${base}"
                                    docker build \
                                        --no-cache \
                                        -t ${base}:${env.IMAGE_TAG_BUILD} \
                                        -t ${base}:latest .
                                    echo "‚úì Backend Docker image built successfully"
                                """
                                
                                // Verify the image was created
                                sh """
                                    echo "Verifying backend image:"
                                    docker images | grep "${base}" || echo "Backend image not found after build"
                                """
                            }
                        }
                    }
                }
                stage('Frontend Image') {
                    steps {
                        dir("${env.FRONTEND_DIR}") {
                            script {
                                echo "=== Building Frontend Docker Image ==="
                                def base = "${env.DOCKER_HUB_REPO}-frontend"
                                
                                // Check if Dockerfile exists
                                if (!fileExists('Dockerfile')) {
                                    echo "WARNING: No Dockerfile in frontend directory, skipping frontend build"
                                    return
                                }
                                
                                sh """
                                    echo "Building Docker image: ${base}"
                                    docker build \
                                        --no-cache \
                                        -t ${base}:${env.IMAGE_TAG_BUILD} \
                                        -t ${base}:latest .
                                    echo "‚úì Frontend Docker image built successfully"
                                """
                                
                                // Verify the image was created
                                sh """
                                    echo "Verifying frontend image:"
                                    docker images | grep "${base}" || echo "Frontend image not found after build"
                                """
                            }
                        }
                    }
                }
            }
        }

        stage('Verify Docker Images') {
            steps {
                script {
                    echo "=== Verifying All Docker Images ==="
                    sh """
                        echo "List of all Docker images for ${env.DOCKER_HUB_REPO}:"
                        docker images | grep "${env.DOCKER_HUB_REPO}" || echo "No images found for repository"
                        
                        echo "Total Docker images on system:"
                        docker images | wc -l
                    """
                }
            }
        }

        stage('Test Docker Push (Optional)') {
            when { expression { return params.PUSH_TO_DOCKER } }
            steps {
                script {
                    echo "=== Testing Docker Hub Connectivity ==="
                    try {
                        withCredentials([usernamePassword(
                            credentialsId: params.DOCKER_HUB_CREDENTIALS_ID, 
                            usernameVariable: 'DOCKER_USER', 
                            passwordVariable: 'DOCKER_PASS'
                        )]) {
                            sh '''
                                echo "Testing Docker Hub login..."
                                echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                                echo "‚úì Docker Hub login successful"
                                docker logout
                            '''
                        }
                    } catch (Exception e) {
                        echo "WARNING: Docker Hub credentials not available or login failed"
                        echo "Error: ${e.message}"
                    }
                }
            }
        }

        stage('Push to Docker Hub') {
            when { expression { return params.PUSH_TO_DOCKER } }
            steps {
                script {
                    echo "=== Pushing Images to Docker Hub ==="
                    try {
                        withCredentials([usernamePassword(
                            credentialsId: params.DOCKER_HUB_CREDENTIALS_ID, 
                            usernameVariable: 'DOCKER_USER', 
                            passwordVariable: 'DOCKER_PASS'
                        )]) {
                            sh """
                                echo "Logging into Docker Hub..."
                                echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                                
                                # Push backend images if they exist
                                if docker images | grep -q "${env.DOCKER_HUB_REPO}-backend"; then
                                    echo "Pushing backend images..."
                                    docker push ${env.DOCKER_HUB_REPO}-backend:${env.IMAGE_TAG_BUILD} || echo "Failed to push ${env.IMAGE_TAG_BUILD}"
                                    docker push ${env.DOCKER_HUB_REPO}-backend:latest || echo "Failed to push latest"
                                    echo "‚úì Backend images pushed"
                                else
                                    echo "Backend image not found, skipping push"
                                fi
                                
                                # Push frontend images if they exist
                                if docker images | grep -q "${env.DOCKER_HUB_REPO}-frontend"; then
                                    echo "Pushing frontend images..."
                                    docker push ${env.DOCKER_HUB_REPO}-frontend:${env.IMAGE_TAG_BUILD} || echo "Failed to push ${env.IMAGE_TAG_BUILD}"
                                    docker push ${env.DOCKER_HUB_REPO}-frontend:latest || echo "Failed to push latest"
                                    echo "‚úì Frontend images pushed"
                                else
                                    echo "Frontend image not found, skipping push"
                                fi
                                
                                docker logout
                                echo "‚úì Docker Hub push completed"
                            """
                        }
                    } catch (Exception e) {
                        echo "ERROR: Failed to push to Docker Hub"
                        echo "Error details: ${e.message}"
                        error "Docker Hub push failed. Ensure a Jenkins Username/Password credential exists with ID '${params.DOCKER_HUB_CREDENTIALS_ID}'."
                    }
                }
            }
        }
    }

    post {
        success {
            echo 'üéâ PIPELINE SUCCESSFUL!'
            sh """
                echo "=== Final Results ==="
                echo "Build Number: ${env.BUILD_NUMBER}"
                echo "Backend Image: ${env.DOCKER_HUB_REPO}-backend:${env.IMAGE_TAG_BUILD}"
                echo "Frontend Image: ${env.DOCKER_HUB_REPO}-frontend:${env.IMAGE_TAG_BUILD}"
                echo "=== Built Images ==="
                docker images | grep "${env.DOCKER_HUB_REPO}" || echo "No images to display"
            """
        }
        failure {
            echo '‚ùå PIPELINE FAILED!'
            sh """
                echo "=== Debug Information ==="
                echo "Current directory:"
                pwd
                ls -la
                echo "Docker images:"
                docker images | head -10
            """
        }
        always {
            echo "=== Cleaning Up ==="
            sh """
                echo "Cleaning up Docker resources..."
                docker image prune -f || echo "Docker cleanup failed"
                echo "‚úì Cleanup completed"
            """
        }
    }
}