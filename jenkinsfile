pipeline {
    agent any

    options {
        timestamps()
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '15'))
        parallelsAlwaysFailFast()
    }

    triggers {
        pollSCM('H/1 * * * *')  
    }

    environment {
        DOCKER_HUB_REPO        = 'pathum2002/personal-library'
        BACKEND_DIR           = 'Backend'
        FRONTEND_DIR          = 'frontend/frontend'
        IMAGE_TAG_BUILD       = "${env.BUILD_NUMBER}"
        IMAGE_TAG_COMMIT      = "${env.GIT_COMMIT?.take(12) ?: env.BUILD_NUMBER}"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                sh "chmod +x ${env.BACKEND_DIR}/mvnw"
            }
        }

        stage('Build & Test Backend') {
            steps {
                dir("${env.BACKEND_DIR}") {
                    sh '''
                        echo "=== Building Backend ==="
                        chmod +x ./mvnw
                        ./mvnw -B -DskipTests=true clean verify
                        echo "✓ Backend build completed"
                    '''
                }
            }
        }

        stage('Build Docker Images') {
            parallel {
                stage('Backend Image') {
                    steps {
                        dir("${env.BACKEND_DIR}") {
                            script {
                                echo "=== Building Backend Docker Image ==="
                                def base = "${DOCKER_HUB_REPO}-backend"
                                sh """
                                    docker build \
                                        --no-cache \
                                        -t ${base}:${IMAGE_TAG_BUILD} \
                                        -t ${base}:latest .
                                """
                                sh "echo '✓ Backend image built: ${base}:${IMAGE_TAG_BUILD}'"
                            }
                        }
                    }
                }
                stage('Frontend Image') {
                    steps {
                        dir("${env.FRONTEND_DIR}") {
                            script {
                                echo "=== Building Frontend Docker Image ==="
                                def base = "${DOCKER_HUB_REPO}-frontend"
                                if (!fileExists('Dockerfile')) {
                                    error "No Dockerfile in ${env.FRONTEND_DIR}; cannot build frontend image."
                                }
                                sh """
                                    docker build \
                                        --no-cache \
                                        -t ${base}:${IMAGE_TAG_BUILD} \
                                        -t ${base}:latest .
                                """
                                sh "echo '✓ Frontend image built: ${base}:${IMAGE_TAG_BUILD}'"
                            }
                        }
                    }
                }
            }
        }

        stage('Test Docker Images') {
            steps {
                script {
                    echo "=== Testing Built Images ==="
                    sh """
                        docker images | grep "${DOCKER_HUB_REPO}" || echo "No images found"
                        echo "✓ Docker images verified"
                    """
                }
            }
        }
    }

    post {
        success {
            echo '✓ Pipeline completed successfully!'
            sh """
                echo "=== Final Image List ==="
                docker images | grep "${DOCKER_HUB_REPO}" || echo "No images to display"
            """
        }
        failure {
            echo '✗ FAILURE: Review earlier stage logs.'
        }
        always {
            sh '''
                echo "=== Cleaning up ==="
                docker image prune -f
                echo "✓ Cleanup completed"
            '''
        }
    }
}